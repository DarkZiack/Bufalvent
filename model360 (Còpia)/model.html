<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>
<body>
    <a-scene cursor="rayOrigin: mouse">
        <a-assets>
            <img id="ipresentacio" src="Assets/imagenes/imatge0.jpg">
            <img id="fondo-mapa" src="Assets/imagenes/10.jpg"> 
            <img id="fondo1" src="Assets/imagenes/0.jpg">
            <img id="fondo2" src="Assets/imagenes/1.jpg">
            <img id="fondo3" src="Assets/imagenes/2.jpg">
            <img id="fondo4" src="Assets/imagenes/3.jpg">
            <img id="fondo5" src="Assets/imagenes/4.jpg">
            <img id="fondo6" src="Assets/imagenes/5.jpg">
            <img id="fondo7" src="Assets/imagenes/6.jpg">
            <img id="fondo8" src="Assets/imagenes/7.jpg">
            <img id="fondo9" src="Assets/imagenes/8.jpg">
            <img id="fondo_blancoYnegro" src="Assets/imagenes/fondo_blancoYnegro.jpg">
            <img id="dibuplano" src="Assets/imagenes/plano.jpg">
            <img id="bes" src="Assets/imagenes/bes.png">
            <img id="bcat" src="Assets/imagenes/bcat.png">
            <img id="buk" src="Assets/imagenes/buk.png">
            <img id="ins" src="Assets/imagenes/logo1.png">
            <img id="gen" src="Assets/imagenes/logo2.png">
            <img id="casa" src="Assets/imagenes/casa.jpg">

            <audio id="Intro-cat" src="Assets/audios/cat/Intro.mp3"></audio>
            <audio id="Intro-es" src="Assets/audios/es/Intro.mp3"></audio>
            <audio id="Intro-uk" src="Assets/audios/en/Intro.mp3"></audio>
        </a-assets>

        <a-entity camera look-controls></a-entity>
        <a-sky id="sky" src="#fondo_blancoYnegro"></a-sky>
        
        <a-entity id="ui-menu" visible="true">
            <a-text id="titolMenu" value="Parc Ambiental del Bufalvent" position="0 2.8 -20" align="center" color="red" width="45"></a-text>
            <a-plane id="es" position="-1.5 -0.5 -2" src="#bes" language-selector="lang: es"></a-plane>
            <a-plane id="cat" position="0 -0.5 -2" src="#bcat" language-selector="lang: cat"></a-plane>
            <a-plane id="uk" position="1.5 -0.5 -2" src="#buk" language-selector="lang: uk"></a-plane>
            
            <a-plane position="0 0.5 2.5" src="#ins" rotation="0 180 0"></a-plane>
            <a-plane position="0 -0.5 2.5" src="#gen" rotation="0 180 0"></a-plane>
        </a-entity>

        <a-entity id="ui-exploracion" visible="false">
            <a-plane id="plano" position="0 -1 -2" src="#dibuplano" scale="2 1 2"></a-plane>
            
            <a-sphere position="-0.75 -0.80 -2" radius="0.03" color="black" data-fondo="fondo1" mostrar-fondo></a-sphere>
            <a-sphere position="-0.68 -0.86 -2" radius="0.03" color="black" data-fondo="fondo2" mostrar-fondo></a-sphere>
            <a-sphere position="-0.78 -1 -2" radius="0.03" color="black" data-fondo="fondo3" mostrar-fondo></a-sphere>
            <a-sphere position="0.1 -1.3 -2" radius="0.03" color="black" data-fondo="fondo4" mostrar-fondo></a-sphere>
            <a-sphere position="-0.4 -1.15 -2" radius="0.03" color="black" data-fondo="fondo5" mostrar-fondo></a-sphere>
            <a-sphere position="0.37 -1.11 -2" radius="0.03" color="black" data-fondo="fondo6" mostrar-fondo></a-sphere>
            <a-sphere position="-0.23 -0.7 -2" radius="0.03" color="black" data-fondo="fondo7" mostrar-fondo></a-sphere>
            <a-sphere position="0.35 -0.70 -2" radius="0.03" color="black" data-fondo="fondo8" mostrar-fondo></a-sphere>
            <a-sphere position="0.1 -0.65 -2" radius="0.03" color="black" data-fondo="fondo9" mostrar-fondo></a-sphere>

            <a-plane id="btnCasa" position="0 -1.5 -1.8" src="#casa" scale="0.3 0.3 0.3" back-to-menu></a-plane>
        </a-entity>

        <a-entity id="sound" sound="autoplay: false"></a-entity>
    </a-scene>

    <script>
        const sky = document.querySelector('#sky');
        const soundEl = document.querySelector('#sound');
        const uiMenu = document.querySelector('#ui-menu');
        const uiExploracion = document.querySelector('#ui-exploracion');
        
        let idiomaGlobal = "cat";
        let isLanguageSelected = false; // Our "Guard" variable

        function playAudio(fileName) {
            if (soundEl.components.sound) {
                soundEl.components.sound.stopSound();
            }
            let folder = idiomaGlobal === "uk" ? "en" : idiomaGlobal;
            const audioPath = `Assets/audios/${folder}/${fileName}.mp3`;
            
            soundEl.setAttribute('sound', {
                src: `url(${audioPath})`,
                autoplay: true,
                positional: false,
                volume: 1
            });
            soundEl.addEventListener('sound-loaded', () => {
                soundEl.components.sound.playSound();
            }, { once: true });
        }

        AFRAME.registerComponent('language-selector', {
            schema: { lang: {type: 'string'} },
            init: function () {
                this.el.addEventListener('click', () => {
                    // Logic lock to prevent misclicks
                    if (isLanguageSelected) return;
                    isLanguageSelected = true;

                    idiomaGlobal = this.data.lang;
                    
                    // Hide menu (and the logos inside it)
                    uiMenu.setAttribute('visible', false);
                    uiExploracion.setAttribute('visible', true);
                    
                    sky.setAttribute('src', '#fondo-mapa');
                    playAudio("Intro");
                });
            }
        });

        AFRAME.registerComponent('mostrar-fondo', {
            init: function () {
                this.el.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const fondoId = this.el.getAttribute('data-fondo');
                    sky.setAttribute('src', '#' + fondoId);
                    playAudio(fondoId);
                });
                this.el.setAttribute('animation', "property: scale; dur: 1000; to: 1.2 1.2 1.2; dir: alternate; loop: true");
            }
        });

        AFRAME.registerComponent('back-to-menu', {
            init: function () {
                this.el.addEventListener('click', () => {
                    isLanguageSelected = false; // Reset lock
                    uiExploracion.setAttribute('visible', false);
                    uiMenu.setAttribute('visible', true); // Logos become visible again
                    sky.setAttribute('src', '#fondo_blancoYnegro');
                    if(soundEl.components.sound) soundEl.components.sound.stopSound();
                });
            }
        });
    </script>
</body>
</html>